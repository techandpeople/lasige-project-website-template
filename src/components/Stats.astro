---
interface StatItem {
	value: number;
	label: string;
	suffix?: string;
	prefix?: string;
}

interface Props {
	stats: StatItem[];
	title?: string;
}

const { stats, title } = Astro.props;
if (!stats?.length) return;
---

<section
	id="stats"
	aria-labelledby={title ? 'stats-heading' : undefined}
	class="pt-24 pb-20 min-h-screen bg-surface"
>
	<div class="max-w-6xl mx-auto px-4">
		{title && (
			<>
				<h2 id="stats-heading" class="text-3xl md:text-4xl font-bold text-primary mb-4 text-center">
					{title}
				</h2>
				<div class="w-16 h-1 bg-accent mx-auto mb-12 rounded-full"></div>
			</>
		)}

		<div class="grid grid-cols-2 md:grid-cols-4 gap-8 md:gap-12">
			{stats.map((stat) => (
				<div
					class="text-center"
					data-counter
					data-value={stat.value}
					data-suffix={stat.suffix ?? ''}
					data-prefix={stat.prefix ?? ''}
				>
					<div class="text-5xl md:text-6xl font-bold text-primary mb-3 tabular-nums leading-none">
						<span class="stat-prefix opacity-70">{stat.prefix ?? ''}</span><span class="stat-number">0</span><span class="stat-suffix opacity-70">{stat.suffix ?? ''}</span>
					</div>
					<div class="text-muted text-sm font-medium uppercase tracking-widest">{stat.label}</div>
				</div>
			))}
		</div>
	</div>
</section>

<script>
	const counters = document.querySelectorAll<HTMLElement>('[data-counter]');

	function animateCounter(el: HTMLElement) {
		const target = parseInt(el.dataset.value ?? '0', 10);
		const numberEl = el.querySelector<HTMLElement>('.stat-number');
		if (!numberEl) return;

		if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
			numberEl.textContent = target.toLocaleString();
			return;
		}

		const duration = 1500;
		const start = performance.now();

		function easeOutCubic(t: number): number {
			return 1 - Math.pow(1 - t, 3);
		}

		function step(now: number) {
			const elapsed = now - start;
			const progress = Math.min(elapsed / duration, 1);
			const current = Math.round(easeOutCubic(progress) * target);
			numberEl!.textContent = current.toLocaleString();
			if (progress < 1) requestAnimationFrame(step);
		}

		requestAnimationFrame(step);
	}

	const observer = new IntersectionObserver(
		(entries) => {
			entries.forEach((entry) => {
				if (entry.isIntersecting) {
					animateCounter(entry.target as HTMLElement);
					observer.unobserve(entry.target);
				}
			});
		},
		{ threshold: 0.3 }
	);

	counters.forEach((el) => observer.observe(el));
</script>
