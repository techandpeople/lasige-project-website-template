---
import fs from 'node:fs';
import { getCollection } from 'astro:content';
import site from '../../site.yaml';
import { type UIStrings, contentId, getLocalizedEntries } from '../i18n';
import { getSiteConfig } from '../i18n/site';
import LanguageSwitcher from './LanguageSwitcher.astro';

interface Props {
	lang: string;
	ui: UIStrings;
}

const { lang, ui } = Astro.props;
const siteConfig = getSiteConfig(lang);
const { navigation, project } = site;

// Build nav items automatically from all content collections
const allSections = await getCollection('sections');
const allTeam = await getCollection('team');
const allFunders = await getCollection('funders');
const allDeliverables = await getCollection('deliverables');

const contentSections = getLocalizedEntries(allSections, lang);
const teamMembers = getLocalizedEntries(allTeam, lang);
const funderEntries = getLocalizedEntries(allFunders, lang);
const deliverableEntries = getLocalizedEntries(allDeliverables, lang);

const orderMap: Record<string, number> = site.sectionOrder ?? {};
function getOrder(id: string, fallback: number): number {
	return orderMap[id] ?? fallback;
}

type NavItem = { label: string; href: string; order: number };
const navItems: NavItem[] = [
	{ label: ui.nav.home, href: '#hero', order: 0 },
	...contentSections.map((s: { id: string; data: { navLabel?: string; title: string; order: number } }) => ({
		label: s.data.navLabel || s.data.title,
		href: `#${contentId(s.id)}`,
		order: getOrder(contentId(s.id), s.data.order),
	})),
];

const galleryDir = new URL('../../public/images/gallery', import.meta.url);
const hasGallery = fs.existsSync(galleryDir) &&
	fs.readdirSync(galleryDir).some((f: string) => /\.(jpe?g|png|webp|gif|avif|svg)$/i.test(f));
if (hasGallery) {
	navItems.push({
		label: siteConfig.gallery?.navLabel || siteConfig.gallery?.title || 'Gallery',
		href: '#gallery',
		order: getOrder('gallery', siteConfig.gallery?.order ?? 80),
	});
}
if (deliverableEntries.length > 0) {
	navItems.push({
		label: siteConfig.deliverables?.navLabel || siteConfig.deliverables?.title || 'Deliverables',
		href: '#deliverables',
		order: getOrder('deliverables', siteConfig.deliverables?.order ?? 30),
	});
}
if (teamMembers.length > 0) {
	navItems.push({
		label: siteConfig.team?.navLabel || siteConfig.team?.title || 'Team',
		href: '#team',
		order: getOrder('team', siteConfig.team?.order ?? 90),
	});
}
if (funderEntries.length > 0) {
	navItems.push({
		label: siteConfig.funding?.navLabel || siteConfig.funding?.title || 'Funding',
		href: '#funding',
		order: getOrder('funding', siteConfig.funding?.order ?? 95),
	});
}

navItems.sort((a, b) => a.order - b.order);
---
<nav id="navbar" class="fixed top-0 w-full z-50 bg-white/90 backdrop-blur-md shadow-sm">
	<div class="max-w-6xl mx-auto px-4 flex items-center justify-between h-16">
		<a href="#hero" class="flex items-center gap-2">
			{navigation?.logo && (
				<img src={navigation.logo} alt={project.name} class="h-8" />
			)}
			<span class="font-bold text-primary text-lg">{project.name}</span>
		</a>

		<div class="hidden md:flex items-center gap-6">
			<ul class="flex gap-6">
				{navItems.map((item) => (
					<li>
						<a
							href={item.href}
							class="nav-link text-body hover:text-primary transition-all font-medium px-3 py-1 rounded-md"
						>
							{item.label}
						</a>
					</li>
				))}
			</ul>
			<LanguageSwitcher currentLang={lang} />
		</div>

		<div class="flex items-center gap-2 md:hidden">
			<LanguageSwitcher currentLang={lang} />
			<button
				id="menu-toggle"
				class="hamburger p-2 text-body hover:text-primary"
				aria-label={ui.nav.toggleMenu}
			>
				<span></span>
				<span></span>
				<span></span>
			</button>
		</div>
	</div>

	<div id="mobile-menu" class="mobile-menu bg-white">
		<ul class="flex flex-col p-4 gap-2">
			{navItems.map((item) => (
				<li>
					<a
						href={item.href}
						class="nav-link block py-2 text-body hover:text-primary transition-all font-medium px-3 rounded-lg"
					>
						{item.label}
					</a>
				</li>
			))}
		</ul>
	</div>
</nav>

<style>
	/* Hamburger icon */
	.hamburger {
		display: flex;
		flex-direction: column;
		justify-content: center;
		gap: 5px;
		width: 2.5rem;
		height: 2.5rem;
		cursor: pointer;
	}
	.hamburger span {
		display: block;
		width: 22px;
		height: 2px;
		background: currentColor;
		border-radius: 1px;
		transition: transform 0.3s ease, opacity 0.3s ease;
		margin: 0 auto;
	}
	.hamburger.open span:nth-child(1) {
		transform: translateY(7px) rotate(45deg);
	}
	.hamburger.open span:nth-child(2) {
		opacity: 0;
	}
	.hamburger.open span:nth-child(3) {
		transform: translateY(-7px) rotate(-45deg);
	}

	/* Mobile menu */
	.mobile-menu {
		max-height: 0;
		overflow: hidden;
		transition: max-height 0.3s ease-out;
	}
	.mobile-menu.open {
		max-height: 20rem;
		border-top: 1px solid #e5e7eb;
	}
	@media (min-width: 48rem) {
		.hamburger {
			display: none;
		}
		.mobile-menu {
			display: none;
		}
	}
</style>

<script>
	const toggle = document.getElementById('menu-toggle');
	const menu = document.getElementById('mobile-menu');

	toggle?.addEventListener('click', () => {
		toggle.classList.toggle('open');
		menu?.classList.toggle('open');
	});

	document.querySelectorAll('#mobile-menu a').forEach(link => {
		link.addEventListener('click', () => {
			toggle?.classList.remove('open');
			menu?.classList.remove('open');
		});
	});
</script>
