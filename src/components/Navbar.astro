---
import { getCollection } from 'astro:content';
import { hasGalleryImages } from '../utils/gallery';
import { withBase } from '../utils/url';
import site from '../../site-config.yaml';
import { type UIStrings, contentId, getLocalizedEntries } from '../i18n';
import { getSiteConfig } from '../i18n/site';
import LanguageSwitcher from './LanguageSwitcher.astro';

interface Props {
	lang: string;
	ui: UIStrings;
}

const { lang, ui } = Astro.props;
const siteConfig = getSiteConfig(lang);
const { navigation, project } = site;

// Build nav items automatically from all content collections
const allSections = await getCollection('sections');
const allTeam = await getCollection('team');
const allFunders = await getCollection('funders');
const allDeliverables = await getCollection('deliverables');

const contentSections = getLocalizedEntries(allSections, lang);
const teamMembers = getLocalizedEntries(allTeam, lang);
const funderEntries = getLocalizedEntries(allFunders, lang);
const deliverableEntries = getLocalizedEntries(allDeliverables, lang);

const sectionOrder: string[] = site.sectionOrder ?? [];
function getOrder(id: string, fallback: number): number {
	const idx = sectionOrder.indexOf(id);
	return idx >= 0 ? idx : sectionOrder.length + fallback;
}

type NavItem = { label: string; href: string; order: number };
const navItems: NavItem[] = [
	{ label: ui.nav.home, href: '#hero', order: 0 },
	...contentSections.map((s: { id: string; data: { navLabel?: string; title: string; order: number } }) => ({
		label: s.data.navLabel || s.data.title,
		href: `#${contentId(s.id)}`,
		order: getOrder(contentId(s.id), s.data.order),
	})),
];

const hasGallery = hasGalleryImages();
if (hasGallery) {
	navItems.push({
		label: siteConfig.gallery?.navLabel || siteConfig.gallery?.title || 'Gallery',
		href: '#gallery',
		order: getOrder('gallery', siteConfig.gallery?.order ?? 80),
	});
}
if (deliverableEntries.length > 0) {
	navItems.push({
		label: siteConfig.deliverables?.navLabel || siteConfig.deliverables?.title || 'Deliverables',
		href: '#deliverables',
		order: getOrder('deliverables', siteConfig.deliverables?.order ?? 30),
	});
}
if (teamMembers.length > 0) {
	navItems.push({
		label: siteConfig.team?.navLabel || siteConfig.team?.title || 'Team',
		href: '#team',
		order: getOrder('team', siteConfig.team?.order ?? 90),
	});
}
if (funderEntries.length > 0) {
	navItems.push({
		label: siteConfig.funding?.navLabel || siteConfig.funding?.title || 'Funding',
		href: '#funding',
		order: getOrder('funding', siteConfig.funding?.order ?? 95),
	});
}
if (siteConfig.recruitment) {
	navItems.push({
		label: siteConfig.recruitment?.navLabel || siteConfig.recruitment?.title || 'Participate',
		href: '#recruitment',
		order: getOrder('recruitment', siteConfig.recruitment?.order ?? 85),
	});
}

navItems.sort((a, b) => a.order - b.order);
---
<a
	href="#hero"
	class="fixed top-0 left-4 z-[9999] px-4 py-2 rounded-b-md bg-primary text-white font-medium -translate-y-full focus:translate-y-0 transition-transform duration-150"
>
	{ui.nav.skipToContent}
</a>
<nav id="navbar" aria-label={ui.nav.mainNav} class="fixed top-0 w-full z-50 bg-white/90 backdrop-blur-md shadow-sm">
	<div class="max-w-6xl mx-auto px-4 flex items-center justify-between h-16">
		<a href="#hero" class="flex items-center gap-2">
			{navigation?.logo && (
				<img src={withBase(navigation.logo)} alt={project.name} class="h-8" />
			)}
			<span class="font-bold text-primary text-lg">{project.name}</span>
		</a>

		<div class="hidden md:flex items-center gap-6">
			<ul class="flex gap-6">
				{navItems.map((item) => (
					<li>
						<a
							href={item.href}
							class="nav-link text-body hover:text-primary transition-all font-medium px-3 py-1 rounded-md"
						>
							{item.label}
						</a>
					</li>
				))}
			</ul>
			<LanguageSwitcher currentLang={lang} />
		</div>

		<div class="flex items-center gap-2 md:hidden">
			<LanguageSwitcher currentLang={lang} />
			<button
				id="menu-toggle"
				class="hamburger p-2 text-body hover:text-primary"
				aria-label={ui.nav.toggleMenu}
				aria-expanded="false"
				aria-controls="mobile-menu"
			>
				<span></span>
				<span></span>
				<span></span>
			</button>
		</div>
	</div>

	<div id="mobile-menu" class="mobile-menu bg-white">
		<ul class="flex flex-col p-4 gap-2">
			{navItems.map((item) => (
				<li>
					<a
						href={item.href}
						class="nav-link block py-2 text-body hover:text-primary transition-all font-medium px-3 rounded-lg"
					>
						{item.label}
					</a>
				</li>
			))}
		</ul>
	</div>
</nav>

<style>
	/* Hamburger icon */
	.hamburger {
		display: flex;
		flex-direction: column;
		justify-content: center;
		gap: 5px;
		width: 2.5rem;
		height: 2.5rem;
		cursor: pointer;
	}
	.hamburger span {
		display: block;
		width: 22px;
		height: 2px;
		background: currentColor;
		border-radius: 1px;
		transition: transform 0.3s ease, opacity 0.3s ease;
		margin: 0 auto;
	}
	.hamburger.open span:nth-child(1) {
		transform: translateY(7px) rotate(45deg);
	}
	.hamburger.open span:nth-child(2) {
		opacity: 0;
	}
	.hamburger.open span:nth-child(3) {
		transform: translateY(-7px) rotate(-45deg);
	}

	/* Mobile menu */
	.mobile-menu {
		max-height: 0;
		overflow: hidden;
		transition: max-height 0.3s ease-out;
	}
	.mobile-menu.open {
		max-height: 20rem;
		border-top: 1px solid #e5e7eb;
	}
	@media (min-width: 48rem) {
		.hamburger {
			display: none;
		}
		.mobile-menu {
			display: none;
		}
	}
</style>

<script>
	const toggle = document.getElementById('menu-toggle');
	const menu = document.getElementById('mobile-menu');

	toggle?.addEventListener('click', () => {
		const isOpen = toggle.classList.toggle('open');
		menu?.classList.toggle('open');
		toggle.setAttribute('aria-expanded', String(isOpen));
	});

	document.querySelectorAll('#mobile-menu a').forEach(link => {
		link.addEventListener('click', () => {
			toggle?.classList.remove('open');
			menu?.classList.remove('open');
			toggle?.setAttribute('aria-expanded', 'false');
		});
	});

	// Active section â†’ aria-current + active-nav class
	const navLinks = document.querySelectorAll<HTMLAnchorElement>('.nav-link');
	const sectionObserver = new IntersectionObserver(
		(entries) => {
			entries.forEach(entry => {
				if (!entry.isIntersecting) return;
				const id = entry.target.id;
				navLinks.forEach(link => {
					const isActive = link.getAttribute('href') === `#${id}`;
					link.classList.toggle('active-nav', isActive);
					link.setAttribute('aria-current', isActive ? 'true' : 'false');
				});
			});
		},
		{ rootMargin: '-45% 0px -45% 0px', threshold: 0 }
	);
	document.querySelectorAll<HTMLElement>('section[id]').forEach(el => sectionObserver.observe(el));
</script>
